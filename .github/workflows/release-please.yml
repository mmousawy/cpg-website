name: Release Please

on:
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: write

jobs:
  release-please:
    runs-on: ubuntu-latest
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
      version: ${{ steps.release.outputs.version }}
      major: ${{ steps.release.outputs.major }}
      minor: ${{ steps.release.outputs.minor }}
      patch: ${{ steps.release.outputs.patch }}
    steps:
      - uses: googleapis/release-please-action@v4
        id: release
        with:
          release-type: node
          target-branch: main

  # When a release is created, create/update the release branch and trigger CI
  create-release-branch:
    runs-on: ubuntu-latest
    needs: release-please
    if: ${{ needs.release-please.outputs.release_created }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create or update release branch
        env:
          VERSION: ${{ needs.release-please.outputs.version }}
          MAJOR: ${{ needs.release-please.outputs.major }}
          MINOR: ${{ needs.release-please.outputs.minor }}
        run: |
          # Create a release branch for this version (e.g., release/1.2)
          RELEASE_BRANCH="release/${MAJOR}.${MINOR}"
          
          echo "Creating/updating branch: $RELEASE_BRANCH"
          
          # Check if branch exists
          if git ls-remote --heads origin "$RELEASE_BRANCH" | grep -q "$RELEASE_BRANCH"; then
            echo "Branch exists, updating..."
            git checkout "$RELEASE_BRANCH"
            git merge origin/main --no-edit
            git push origin "$RELEASE_BRANCH"
          else
            echo "Creating new branch..."
            git checkout -b "$RELEASE_BRANCH"
            git push origin "$RELEASE_BRANCH"
          fi
          
          echo "Release branch $RELEASE_BRANCH is now at version $VERSION"
